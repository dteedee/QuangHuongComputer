# ===========================================
# CD Pipeline - Deploy to Test Environment
# ===========================================
# Triggers: Push to develop branch (after CI passes)
# ===========================================

name: CD - Deploy to Test

on:
  push:
    branches: [develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Build & Push Docker Images
  # ============================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      backend_image: ${{ steps.meta-backend.outputs.tags }}
      frontend_image: ${{ steps.meta-frontend.outputs.tags }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          VERSION="test-$(date +'%Y%m%d')-${GITHUB_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (Backend)
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=test-latest

      - name: Extract metadata (Frontend)
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=test-latest

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_API_URL=${{ secrets.TEST_API_URL || 'http://localhost:5001' }}
            VITE_NODE_ENV=test

  # ============================================
  # Deploy to Test Environment
  # ============================================
  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: test
      url: ${{ secrets.TEST_URL || 'http://localhost:3001' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy notification - Start
        run: |
          echo "## ðŸš€ Deploying to Test Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build-and-push.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      # Option 1: Deploy via SSH to remote server
      - name: Deploy via SSH
        if: secrets.TEST_SSH_HOST != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SSH_HOST }}
          username: ${{ secrets.TEST_SSH_USER }}
          key: ${{ secrets.TEST_SSH_KEY }}
          port: ${{ secrets.TEST_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.TEST_DEPLOY_PATH || '/opt/quanghuong' }}

            # Pull latest images
            docker pull ${{ env.BACKEND_IMAGE }}:${{ needs.build-and-push.outputs.version }}
            docker pull ${{ env.FRONTEND_IMAGE }}:${{ needs.build-and-push.outputs.version }}

            # Update docker-compose with new image tags
            export BACKEND_IMAGE_TAG=${{ needs.build-and-push.outputs.version }}
            export FRONTEND_IMAGE_TAG=${{ needs.build-and-push.outputs.version }}

            # Deploy
            docker-compose -f docker-compose.test.yml --env-file .env.test up -d --force-recreate

            # Wait for health check
            sleep 30

            # Verify deployment
            curl -f http://localhost:5001/health || exit 1

            # Cleanup old images
            docker image prune -f

      # Option 2: Deploy via Docker Compose (local/self-hosted runner)
      - name: Deploy via Docker Compose
        if: secrets.TEST_SSH_HOST == ''
        run: |
          echo "Deploying with Docker Compose..."
          echo "Backend Image: ${{ env.BACKEND_IMAGE }}:${{ needs.build-and-push.outputs.version }}"
          echo "Frontend Image: ${{ env.FRONTEND_IMAGE }}:${{ needs.build-and-push.outputs.version }}"

          # For self-hosted runners with Docker access
          # docker-compose -f docker-compose.test.yml up -d

      - name: Health check
        run: |
          echo "Waiting for services to be ready..."
          sleep 10

          # Check if TEST_URL is available
          if [ -n "${{ secrets.TEST_URL }}" ]; then
            for i in {1..30}; do
              if curl -sf "${{ secrets.TEST_URL }}/health" > /dev/null; then
                echo "âœ… Health check passed!"
                exit 0
              fi
              echo "Waiting for service... (attempt $i/30)"
              sleep 10
            done
            echo "âŒ Health check failed after 5 minutes"
            exit 1
          else
            echo "âš ï¸ TEST_URL not configured, skipping health check"
          fi

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add smoke test commands here
          # Example: npm run test:e2e:smoke

      - name: Deploy notification - Complete
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test URL:** ${{ secrets.TEST_URL || 'http://localhost:3001' }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ secrets.TEST_API_URL || 'http://localhost:5001' }}" >> $GITHUB_STEP_SUMMARY

      - name: Deploy notification - Failed
        if: failure()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for more details." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Run Integration Tests
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-test
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run API integration tests
        run: |
          echo "Running API integration tests against Test environment..."
          # npm run test:integration
        env:
          API_BASE_URL: ${{ secrets.TEST_API_URL || 'http://localhost:5001' }}

      - name: Run E2E tests
        run: |
          echo "Running E2E tests..."
          # npx playwright test --project=chromium
        env:
          BASE_URL: ${{ secrets.TEST_URL || 'http://localhost:3001' }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ============================================
  # Cleanup on Failure
  # ============================================
  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    needs: [deploy-test, integration-tests]
    if: failure()

    steps:
      - name: Rollback notification
        run: |
          echo "## âš ï¸ Deployment Issue Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Consider rolling back to the previous version if issues persist." >> $GITHUB_STEP_SUMMARY

      # Optional: Auto-rollback
      # - name: Rollback deployment
      #   if: secrets.TEST_SSH_HOST != ''
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.TEST_SSH_HOST }}
      #     username: ${{ secrets.TEST_SSH_USER }}
      #     key: ${{ secrets.TEST_SSH_KEY }}
      #     script: |
      #       cd ${{ secrets.TEST_DEPLOY_PATH }}
      #       docker-compose -f docker-compose.test.yml down
      #       # Restore previous version
